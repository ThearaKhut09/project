<!DOCTYPE html>
<html lang="km">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“</title>
</head>

<body class="flex justify-center py-10" style="
      background-image: url('/mnt/data/b3f5b37a-a855-4074-93c1-1e77df97601e.png');
      background-repeat: repeat-y;
      background-size: contain;
      background-position: center top;
    ">
  <div class="w-full max-w-4xl px-6">
    <!-- Header -->
    <div class="flex items-center justify-between border-b pb-4 mb-10">
      <div onclick="window.location.href='index.html'" class="flex items-center gap-2 cursor-pointer">
        <span class="text-2xl">&larr;</span>
        <span class="text-xl">ááŸ’ášá›á”áŸ‹á€áŸ’ášáŸ„á™</span>
      </div>
      <h1 class="text-3xl font-bold text-center">á…áŸ‚á€ášáŸ†á›áŸ‚á€ášá¼á”á˜á“áŸ’á</h1>
      <div></div>
    </div>

    <!-- FORM -->
    <form id="foodPostForm" class="space-y-10">
      <!-- Name -->
      <div class="grid grid-cols-4 gap-4 items-center">
        <label class="font-medium" for="foodName">áˆáŸ’á˜áŸ„áŸ‡ á˜á»áá˜áŸ’á á¼á” <span class="text-red-500">*</span></label>
        <input type="text" id="foodName" name="title" required class="col-span-3 border px-4 py-3 rounded-lg w-full"
          placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á˜á»áá˜áŸ’á á¼á”" />
      </div>

      <!-- Category (tags) -->
      <div class="grid grid-cols-4 gap-4 items-center">
        <label class="font-medium" for="foodCategory">á”áŸ’ášá—áŸá‘á˜áŸ’á á¼á”</label>
        <select id="foodCategory" name="category" class="col-span-3 border px-4 py-3 rounded-lg w-full">
          <option value="">áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸ</option>
          <option value="á”á„áŸ’á¢áŸ‚á˜">á”á„áŸ’á¢áŸ‚á˜</option>
          <option value="á“áŸ†">á“áŸ†</option>
          <option value="áŸá˜áŸ’á›">áŸá˜áŸ’á›</option>
        </select>
      </div>

      <!-- Cooking Time -->
      <div class="grid grid-cols-4 gap-4 items-center">
        <label class="font-medium" for="cookingTime">á–áŸá›áœáŸá›á¶á’áŸ’áœá¾á˜áŸ’á á¼á” (á“á¶á‘á¸)</label>
        <input type="number" id="cookingTime" name="cooking_time_minutes" min="1" placeholder="ex: 30"
          class="col-span-3 border px-4 py-3 rounded-lg w-full" />
      </div>

      <!-- Difficulty Level -->
      <div class="grid grid-cols-4 gap-4 items-center">
        <label class="font-medium">á€á˜áŸ’ášá·áá›áŸ†á”á¶á€</label>

        <div class="col-span-3 flex gap-10">
          <label class="flex items-center gap-2">
            <input type="radio" name="difficulty_level" value="easy" checked /> á„á¶á™áŸáŸ’ášá½á›
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" name="difficulty_level" value="medium" /> á˜á’áŸ’á™á˜
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" name="difficulty_level" value="hard" /> á›áŸ†á”á¶á€
          </label>
        </div>
      </div>

      <!-- Upload Image -->
      <div class="grid grid-cols-4 gap-4 items-center">
        <label class="font-medium" for="imageUrl">ááŸ†áášá¼á”á—á¶á–</label>
        <div class="col-span-3 space-y-3">
          <input type="url" id="imageUrl" name="image_url" placeholder="https://example.com/image.jpg"
            class="border px-4 py-3 rounded-lg w-full" />
        </div>
      </div>

      <!-- Dynamic Ingredients -->
      <div class="grid grid-cols-4 gap-4">
        <label class="font-medium mt-3">á‚áŸ’ášá¿á„á•áŸ’áŸáŸ†</label>

        <div class="col-span-3 space-y-3">
          <div class="flex items-center justify-end">
            <button type="button" id="removeIngredientBtn" onclick="removeIngredient()"
              class="bg-red-500 text-white px-4 py-1 rounded-lg hover:bg-red-600">
              á›á»á”
            </button>
          </div>

          <div id="ingredientList" class="space-y-3">
            <input type="text" class="ingredient-input border px-3 py-2 rounded-lg w-full" placeholder="á‚áŸ’ášá¿á„á•áŸ’áŸáŸ† #1" />
          </div>

          <button type="button" onclick="addIngredient()"
            class="bg-green-600 text-white px-4 py-1 rounded-lg hover:bg-green-700">
            + á”á“áŸ’ááŸ‚á˜á‚áŸ’ášá¿á„á•áŸ’áŸáŸ†
          </button>
        </div>
      </div>

      <!-- Steps to Cook -->
      <div class="grid grid-cols-4 gap-4">
        <label class="font-medium mt-3">á‡áŸ†á á¶á“á’áŸ’áœá¾á˜áŸ’á á¼á”</label>

        <div class="col-span-3 space-y-3">
          <div class="flex items-center justify-end">
            <button type="button" id="removeStepBtn" onclick="removeStep()"
              class="bg-red-500 text-white px-4 py-1 rounded-lg hover:bg-red-600">
              á›á»á”
            </button>
          </div>

          <div id="stepList" class="space-y-3">
            <textarea class="step-input border px-3 py-2 rounded-lg w-full" rows="2" placeholder="á‡áŸ†á á¶á“á‘á¸ 1"></textarea>
          </div>

          <button type="button" onclick="addStep()"
            class="bg-green-600 text-white px-4 py-1 rounded-lg hover:bg-green-700">
            + á”á“áŸ’ááŸ‚á˜á‡áŸ†á á¶á“
          </button>
        </div>
      </div>

      <!-- Description -->
      <div class="grid grid-cols-4 gap-4">
        <label class="font-medium mt-3" for="description">á€á¶ášá–á·á–ááŸŒá“á¶ <span class="text-red-500">*</span></label>
        <textarea id="description" name="description" rows="4" required
          class="col-span-3 border px-4 py-3 rounded-lg w-full" placeholder="á–á·á–ááŸŒá“á¶á¢áŸ†á–á¸á˜á»áá˜áŸ’á á¼á”á“áŸáŸ‡..."></textarea>
      </div>

      <!-- Recipe -->
      <div class="grid grid-cols-4 gap-4">
        <label class="font-medium mt-3" for="recipe">ášá¼á”á˜á“áŸ’á <span class="text-red-500">*</span></label>
        <textarea id="recipe" name="recipe" rows="6" required class="col-span-3 border px-4 py-3 rounded-lg w-full"
          placeholder="á”á‰áŸ’á‡á¶á€áŸ‹ášá¼á”á˜á“áŸ’áá›á˜áŸ’á¢á·áá“áŸ…á‘á¸á“áŸáŸ‡..."></textarea>
      </div>

      <!-- Error/Success Messages -->
      <div id="formMessage" class="hidden col-span-4"></div>

      <!-- Submit -->
      <div class="flex justify-end gap-4">
        <button type="button" onclick="window.location.href='general_food.html'"
          class="bg-gray-400 text-white px-10 py-2 rounded-full hover:bg-gray-500">
          á”áŸ„áŸ‡á”á„áŸ‹
        </button>
        <button type="submit" id="submitBtn" class="bg-green-600 text-white px-10 py-2 rounded-full hover:bg-green-700">
          á”á‰áŸ’á…á¼á“
        </button>
      </div>
    </form>
  </div>

  <!-- JavaScript -->
  <script src="js/api.js"></script>
  <script>


    // Ingredient Management
    function addIngredient() {
      const list = document.getElementById("ingredientList");
      const count = list.children.length + 1;
      const input = document.createElement("input");
      input.type = "text";
      input.className = "ingredient-input border px-3 py-2 rounded-lg w-full";
      input.placeholder = `á‚áŸ’ášá¿á„á•áŸ’áŸáŸ† #${count}`;
      list.appendChild(input);
    }

    function removeIngredient() {
      const list = document.getElementById("ingredientList");
      if (list.children.length > 1) {
        list.removeChild(list.lastChild);
      }
    }

    // Step Management
    function addStep() {
      const list = document.getElementById("stepList");
      const count = list.children.length + 1;
      const textarea = document.createElement("textarea");
      textarea.className = "step-input border px-3 py-2 rounded-lg w-full";
      textarea.rows = 2;
      textarea.placeholder = `á‡áŸ†á á¶á“á‘á¸ ${count}`;
      list.appendChild(textarea);
    }

    function removeStep() {
      const list = document.getElementById("stepList");
      if (list.children.length > 1) {
        list.removeChild(list.lastChild);
      }
    }

    // Form Submission
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("foodPostForm");
      const submitBtn = document.getElementById("submitBtn");
      const formMessage = document.getElementById("formMessage");

      // Check authentication on page load
      checkAuthentication();

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Check if user is authenticated
        const session = window.PteahBayAPI?.getStoredAuthSession();
        if (!session || !session.accessToken) {
          showMessage("áŸá¼á˜á…á¼á›á‚áá“á¸á‡á¶á˜á»á“áŸá·á“!", "error");
          setTimeout(() => {
            window.location.href = "sign_in.html";
          }, 2000);
          return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = "á€áŸ†á–á»á„á”á‰áŸ’á…á¼á“...";

        try {
          submitBtn.textContent = "á€áŸ†á–á»á„á”á„áŸ’á áŸ„áŸ‡ášá¼á”á˜á“áŸ’á...";
          const formData = collectFormData();

          // Validate required fields
          if (!formData.title || !formData.description || !formData.recipe) {
            showMessage("áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á…á¶áŸ†á”á¶á…áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹!", "error");
            submitBtn.disabled = false;
            submitBtn.textContent = "á”á‰áŸ’á…á¼á“";
            return;
          }

          // Create food post
          const response = await window.PteahBayAPI.createFoodPost(formData);

          showMessage("á”á¶á“á”á„áŸ’á áŸ„áŸ‡ášá¼á”á˜á“áŸ’ááŠáŸ„á™á‡áŸ„á‚á‡áŸá™! ğŸ‰", "success");

          // Reset form
          form.reset();
          document.getElementById("ingredientList").innerHTML = `
              <input 
                type="text" 
                class="ingredient-input border px-3 py-2 rounded-lg w-full" 
                placeholder="á‚áŸ’ášá¿á„á•áŸ’áŸáŸ† #1"
              />
            `;
          document.getElementById("stepList").innerHTML = `
              <textarea 
                class="step-input border px-3 py-2 rounded-lg w-full" 
                rows="2"
                placeholder="á‡áŸ†á á¶á“á‘á¸ 1"
              ></textarea>
            `;

          // Redirect to general food page after 2 seconds
          setTimeout(() => {
            window.location.href = "general_food.html";
          }, 2000);

        } catch (error) {
          console.error("Error creating food post:", error);
          let errorMsg = "á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá”á„áŸ’á áŸ„áŸ‡ášá¼á”á˜á“áŸ’ááŸ” ";
          if (error.status === 401) {
            errorMsg += "áŸá¼á˜á…á¼á›á‚áá“á¸á˜áŸ’áá„á‘áŸ€ááŸ”";
            setTimeout(() => {
              window.location.href = "sign_in.html";
            }, 2000);
          } else if (error.message) {
            errorMsg += error.message;
          }
          showMessage(errorMsg, "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "á”á‰áŸ’á…á¼á“";
        }
      });
    });

    function collectFormData() {
      // Get basic form fields
      const title = document.getElementById("foodName").value.trim();
      const description = document.getElementById("description").value.trim();
      const recipe = document.getElementById("recipe").value.trim();
      const cookingTime = document.getElementById("cookingTime").value;
      const servings = document.getElementById("servings").value;
      const imageUrl = document.getElementById("imageUrl").value.trim();
      const category = document.getElementById("foodCategory").value;
      const difficultyLevel = document.querySelector('input[name="difficulty_level"]:checked')?.value || "medium";      // Collect ingredients
      const ingredientInputs = document.querySelectorAll(".ingredient-input");
      const ingredients = Array.from(ingredientInputs)
        .map(input => input.value.trim())
        .filter(val => val !== "");

      // Collect steps
      const stepInputs = document.querySelectorAll(".step-input");
      const steps = Array.from(stepInputs)
        .map(input => input.value.trim())
        .filter(val => val !== "");

      // Build tags array
      const tags = [];
      if (category) {
        tags.push(category);
      }
      tags.push("áŸá á‚á˜á“áŸ"); // Add community tag as requested

      // Build the data object according to FoodPostCreate schema
      const data = {
        title: title,
        description: description,
        recipe: recipe,
        ingredients: ingredients,
        step_to_cook: steps,
        difficulty_level: difficultyLevel,
        tags: tags
      };

      // Add optional fields only if they have values
      if (cookingTime && parseInt(cookingTime) > 0) {
        data.cooking_time_minutes = parseInt(cookingTime);
      }
      if (servings && parseInt(servings) > 0) {
        data.servings = parseInt(servings);
      }
      if (imageUrl) {
        data.image_url = imageUrl;
      }

      return data;
    }

    function showMessage(message, type) {
      const formMessage = document.getElementById("formMessage");
      formMessage.className = type === "success"
        ? "block p-4 rounded-lg bg-green-100 text-green-800 border border-green-300"
        : "block p-4 rounded-lg bg-red-100 text-red-800 border border-red-300";
      formMessage.textContent = message;

      // Scroll to message
      formMessage.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function checkAuthentication() {
      const session = window.PteahBayAPI?.getStoredAuthSession();
      if (!session || !session.accessToken) {
        const warning = document.createElement("div");
        warning.className = "bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded mb-4";
        warning.innerHTML = `
            <p class="font-medium">âš ï¸ áŸá¼á˜á…á¼á›á‚áá“á¸á‡á¶á˜á»á“áŸá·á“!</p>
            <p class="text-sm mt-1">á¢áŸ’á“á€ááŸ’ášá¼áœá…á¼á›á‚áá“á¸áŠá¾á˜áŸ’á”á¸á”á„áŸ’á áŸ„áŸ‡ášá¼á”á˜á“áŸ’ááŸ” 
              <a href="sign_in.html" class="underline font-medium">á…á»á…á‘á¸á“áŸáŸ‡áŠá¾á˜áŸ’á”á¸á…á¼á›á‚áá“á¸</a>
            </p>
          `;

        const form = document.getElementById("foodPostForm");
        form.parentNode.insertBefore(warning, form);

        // Disable form
        const inputs = form.querySelectorAll("input, textarea, select, button");
        inputs.forEach(input => {
          if (input.type !== "button" || input.textContent === "á”á‰áŸ’á…á¼á“") {
            input.disabled = true;
          }
        });
      }
    }
  </script>
</body>

</html>